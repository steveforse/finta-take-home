<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Transactions</h1>

    <div>
      <%= button_to "Sync Now", sync_path, method: :post, class: "btn btn-primary",
          data: { turbo_frame: "_top" } %>
    </div>
  </div>

  <% if notice %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= notice %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title mb-3">Filters</h5>
      <%= form_with url: transactions_path, method: :get, class: "row g-3" do |f| %>
        <!-- Account Type -->
        <div class="col-md-2">
          <%= f.label :account_type, "Source Type", class: "form-label" %>
          <%= f.select :account_type,
              options_for_select([
                ["All", "all"],
                ["Bank", "bank"],
                ["Credit", "credit"]
              ], params[:account_type] || "all"),
              {}, class: "form-select" %>
        </div>

        <!-- Amount Range -->
        <div class="col-md-2">
          <%= f.label :min_amount, "Min Amount", class: "form-label" %>
          <%= f.number_field :min_amount, value: params[:min_amount],
              placeholder: "0.00", step: "0.01", class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :max_amount, "Max Amount", class: "form-label" %>
          <%= f.number_field :max_amount, value: params[:max_amount],
              placeholder: "0.00", step: "0.01", class: "form-control" %>
        </div>

        <!-- Date Range -->
        <div class="col-md-2">
          <%= f.label :start_date, "Start Date", class: "form-label" %>
          <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
        </div>

        <div class="col-md-2">
          <%= f.label :end_date, "End Date", class: "form-label" %>
          <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
        </div>

        <!-- Search -->
        <div class="col-md-3">
          <%= f.label :search, "Search Description", class: "form-label" %>
          <%= f.text_field :search, value: params[:search],
              placeholder: "Search...", class: "form-control" %>
        </div>

        <!-- Category -->
        <div class="col-md-3">
          <%= f.label :category_id, "Category", class: "form-label" %>
          <%= f.select :category_id,
              options_for_select([
                ["All Categories", ""],
                ["Uncategorized", "uncategorized"]
              ] + @categories.map { |c| ["#{c.category_group.name} - #{c.name}", c.id] },
              params[:category_id]),
              {}, class: "form-select" %>
        </div>

        <!-- Buttons -->
        <div class="col-md-6 d-flex align-items-end">
          <%= f.submit "Apply Filters", class: "btn btn-primary me-2" %>
          <%= link_to "Clear Filters", transactions_path, class: "btn btn-outline-secondary" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Sorting -->
  <div class="mb-3">
    <strong>Sort by:</strong>
    <%= link_to "Date", transactions_path(params.permit!.merge(sort: "date", direction: params[:sort] == "date" && params[:direction] == "asc" ? "desc" : "asc")),
        class: "btn btn-sm btn-outline-secondary #{'active' if params[:sort].nil? || params[:sort] == 'date'}" %>
    <%= link_to "Amount", transactions_path(params.permit!.merge(sort: "amount", direction: params[:sort] == "amount" && params[:direction] == "asc" ? "desc" : "asc")),
        class: "btn btn-sm btn-outline-secondary #{'active' if params[:sort] == 'amount'}" %>
    <%= link_to "Description", transactions_path(params.permit!.merge(sort: "description", direction: params[:sort] == "description" && params[:direction] == "asc" ? "desc" : "asc")),
        class: "btn btn-sm btn-outline-secondary #{'active' if params[:sort] == 'description'}" %>
  </div>

  <!-- Transactions Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Date</th>
              <th>Account Type</th>
              <th>Account Name</th>
              <th>Description</th>
              <th class="text-end">Amount</th>
              <th>Status</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody>
            <% @transactions.each do |transaction| %>
              <tr>
                <td><%= transaction.date.strftime("%m/%d/%Y") %></td>
                <td>
                  <span class="badge <%= transaction.account_type == 'BankAccount' ? 'bg-primary' : 'bg-success' %>">
                    <%= transaction.account_type == 'BankAccount' ? 'Bank' : 'Credit' %>
                  </span>
                </td>
                <td>
                  <small class="text-muted">
                    <%= transaction.account.name %>
                  </small>
                </td>
                <td><%= transaction.description %></td>
                <td class="text-end">
                  <span class="<%= transaction.amount_cents < 0 ? 'text-danger' : 'text-success' %>">
                    <%= transaction.amount.format %>
                  </span>
                </td>
                <td>
                  <span class="badge <%= transaction.status == 'success' ? 'bg-success' : 'bg-danger' %>"><%= transaction.status %></span>
                </td>
                <td>
                  <%= form_with model: transaction, url: transaction_path(transaction),
                      method: :patch, class: "d-inline" do |f| %>
                    <%= f.select :category_id,
                        options_for_select(
                          [["Select Category", ""]] +
                          @categories.map { |c| ["#{c.category_group.name} - #{c.name}", c.id] },
                          transaction.category_id
                        ),
                        {},
                        class: "form-select form-select-sm",
                        onchange: "this.form.requestSubmit()" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @transactions.total_pages > 1 %>
        <nav aria-label="Transaction pagination" class="mt-4">
          <ul class="pagination justify-content-center">
            <% if @transactions.prev_page %>
              <li class="page-item">
                <%= link_to "Previous", transactions_path(params.permit!.merge(page: @transactions.prev_page)), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            <% end %>

            <%
              # Calculate page range to show (max 10 pages)
              current = @transactions.current_page
              total = @transactions.total_pages
              max_pages = 10
              
              if total <= max_pages
                page_range = (1..total)
              else
                # Show pages around current page
                half_window = (max_pages / 2).floor
                
                if current <= half_window
                  page_range = (1..max_pages)
                elsif current >= total - half_window
                  page_range = ((total - max_pages + 1)..total)
                else
                  page_range = ((current - half_window)..(current + half_window))
                end
              end
            %>

            <% if page_range.first > 1 %>
              <li class="page-item">
                <%= link_to 1, transactions_path(params.permit!.merge(page: 1)), class: "page-link" %>
              </li>
              <li class="page-item disabled">
                <span class="page-link">...</span>
              </li>
            <% end %>

            <% page_range.each do |page| %>
              <li class="page-item <%= 'active' if page == @transactions.current_page %>">
                <%= link_to page, transactions_path(params.permit!.merge(page: page)), class: "page-link" %>
              </li>
            <% end %>

            <% if page_range.last < total %>
              <li class="page-item disabled">
                <span class="page-link">...</span>
              </li>
              <li class="page-item">
                <%= link_to total, transactions_path(params.permit!.merge(page: total)), class: "page-link" %>
              </li>
            <% end %>

            <% if @transactions.next_page %>
              <li class="page-item">
                <%= link_to "Next", transactions_path(params.permit!.merge(page: @transactions.next_page)), class: "page-link" %>
              </li>
            <% else %>
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            <% end %>
          </ul>
        </nav>
        <p class="text-center text-muted">
          Page <%= @transactions.current_page %> of <%= @transactions.total_pages %>
          (showing <%= @transactions.count %> of <%= @transactions.total_count %> transactions)
        </p>
      <% end %>

      <% if @transactions.empty? %>
        <div class="text-center py-5 text-muted">
          <p>No transactions found. Try adjusting your filters or click "Sync Now" to fetch data.</p>
        </div>
      <% end %>
    </div>
  </div>
</div>
